tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://cloudify.co/spec/cloudify/5.0.5/types.yaml
  - plugin:cloudify-nsx-t-plugin
  - plugin:cloudify-vsphere-plugin
  - common/common.yaml

inputs:

  server_name:
    description: The name of VM.
    type: string
    default: cfy_app_vm

  server_cpus:
    type: integer
    description: Number of CPUs the VM should have.
    default: 1
    constraints:
      - in_range: [1, 4]

  server_memory:
    type: integer
    description: Amount of memory (in MB) the VM should have.
    default: 2048
    constraints:
      - valid_values:
        - 1024
        - 2048
        - 4096

  network_id:
    type: string
    description: A network the VM will be connected to.
    default: cfy-network

  vlan_id:
    type: integer
    description: vLAN ID used in network.
    default: 91

  overlay_static_ip:
    type: string
    default: 10.33.10.11
    constraints:
      - pattern: "10\\.33\\.10\\.(1?[1-9][0-9]?|2[0-4][0-9]|25[0-5])"
    description: >
      Static IP for private overlay. Must be out of DHCP pool scope.

  storage_size:
    type: integer
    default: 1

dsl_definitions:

  connection_config: &connection_config
    username: { get_secret: vcenter_username }
    password: { get_secret: vcenter_password }
    host: { get_secret: vcenter_host }
    port: { get_secret: vcenter_port }
    datacenter_name: { get_secret: vcenter_datacenter_name }
    resource_pool_name: { get_secret: vcenter_resource_pool_name }
    auto_placement: { get_secret: vcenter_auto_placement }
    allow_insecure: { get_secret: vcenter_allow_insecure }

  client_config: &client_config
    host: { get_secret: nsx_t_host }
    port: { get_secret: nsx_t_port }
    username: { get_secret: nsx_t_username }
    password: { get_secret: nsx_t_password }

node_templates:

  vm:
    type: cloudify.vsphere.nodes.Server
    properties:
      use_external_resource: false
      connection_config: *connection_config
      agent_config:
        install_method: remote
        user: centos
        password: { get_secret: vm_password }
      server:
        template: CentOS-7.8.2003-TD
        cpus: { get_input: server_cpus }
        memory: { get_input: server_memory }
        name: { get_input: server_name }
      wait_ip: true
      networking:
        connect_networks:
          - name: { get_attribute: [segment, id] }
            nsx_t_switch: true
            # switch_distributed: true
            use_dhcp: true
    relationships:
      - type: cloudify.relationships.server_connected_to_segment
        target: segment
        target_interfaces:
          cloudify.interfaces.relationship_lifecycle:
            preconfigure:
              inputs:
                ip_v4_address: { get_input: overlay_static_ip }

  vm_port:
    type: cloudify.vsphere.nodes.NIC
    properties:
      connection_config: *connection_config
      name: { get_input: network_id }
    #   switch_distributed: false
    #   network_configuration:
    #     management: true
    #     external: true
    #     switch_distributed: false
    #     use_dhcp: false
    #     network: 172.16.168.0/24
    #     gateway: 172.16.168.1
    #     ip: { get_input: ip_address }
    # relationships:
    #   - type: cloudify.relationships.vsphere.nic_connected_to_network
    #     target: network

  network:
    type: cloudify.vsphere.nodes.Network
    properties:
      use_existing_resource: false
      connection_config: *connection_config
      network:
        name: { get_input: network_id }
        vlan_id: { get_input: vlan_id }
        vswitch_name: RS02-INFRA
        switch_distributed: true

  # storage:
  #   type: cloudify.vsphere.nodes.Storage
  #   properties:
  #     use_existing_resource: false
  #     connection_config: *connection_config
  #     storage:
  #       storage_size: { get_input: storage_size }
  #       parent_key: -1
  #       thin_provision: false
  #       mode: persistent

  segment:
    type: cloudify.nodes.nsx-t.Segment
    properties:
      client_config: *client_config
      resource_config:
        id: cfy-segment
        display_name: cfy-segment
        description: NSX-T Segment Config
        # transport_zone_path RS02-INFRA-VDS-OVERLAY-TZ | Overlay
        transport_zone_path: /infra/sites/default/enforcement-points/default/transport-zones/b3f9ae8b-cdf1-4369-a74e-e59d954a880b
        connectivity_path: { get_attribute: [tier1, resource_config, path] }
        dhcp_config_path: { get_attribute: [dhcp_server_config, resource_config, path] }
        subnet:
          ip_v4_config:
            dhcp_config:
              server_address: 10.33.10.2/24
              lease_time: 86400
              resource_type: SegmentDhcpV4Config
            gateway_address: 10.33.10.1/24
            dhcp_ranges:
              - 10.33.10.3-10.33.10.10
          ip_v6_config:
            dhcp_config:
              server_address: 2001:ab8::2/64
              lease_time: 86400
              resource_type: SegmentDhcpV6Config
            gateway_address: 2001:ab8::1/64
            dhcp_ranges:
              - 2001:ab8::3-2001:ab8::100
    relationships:
      - type: cloudify.relationships.connected_to
        target: tier1
      - type: cloudify.relationships.nsx-t.segment_connected_to_dhcp_server_config
        target: dhcp_server_config

  dhcp_server_config:
    type: cloudify.nodes.nsx-t.DhcpServerConfig
    properties:
      client_config: *client_config
      resource_config:
        id: cfy-dhcp
        display_name: cfy-dhcp
        description: DHCP Server Config
        edge_cluster_path: /infra/sites/default/enforcement-points/default/edge-clusters/57edb96e-3081-4d3a-8ffa-3b64462dd693
        server_addresses:
          - 10.33.10.2/24
          - 2001:ab8::2/64
        lease_time: 86400
    relationships:
      - type: cloudify.relationships.depends_on
        target: tier1

  tier1:
    type: cloudify.nodes.nsx-t.Tier1
    properties:
      client_config: *client_config
      resource_config:
        id: cfy-tier1
        display_name: cfy-tier1
        description: Tier 1 Config
        tier0_path: /infra/tier-0s/RS02-Tier0-Workload
        route_advertisement_types:
          - TIER1_STATIC_ROUTES
          - TIER1_CONNECTED
          - TIER1_NAT
          - TIER1_IPSEC_LOCAL_ENDPOINT
          - TIER1_LB_VIP
          - TIER1_LB_SNAT
          - TIER1_DNS_FORWARDER_IP
